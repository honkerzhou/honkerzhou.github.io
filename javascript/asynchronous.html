<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>异步 | honkerzhou</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <meta name="description" content="honkerzhou-梦想成为优秀的社会主义接班人">
    
    <link rel="preload" href="/assets/css/0.styles.6d920bc0.css" as="style"><link rel="preload" href="/assets/js/app.6ddf0b71.js" as="script"><link rel="preload" href="/assets/js/2.4f1b6d11.js" as="script"><link rel="preload" href="/assets/js/23.8beb0211.js" as="script"><link rel="prefetch" href="/assets/js/10.0ad7123c.js"><link rel="prefetch" href="/assets/js/11.b93ea048.js"><link rel="prefetch" href="/assets/js/12.8e195270.js"><link rel="prefetch" href="/assets/js/13.0d0ec676.js"><link rel="prefetch" href="/assets/js/14.05e957cd.js"><link rel="prefetch" href="/assets/js/15.380cac30.js"><link rel="prefetch" href="/assets/js/16.83b0410b.js"><link rel="prefetch" href="/assets/js/17.a7ad8f01.js"><link rel="prefetch" href="/assets/js/18.5916243c.js"><link rel="prefetch" href="/assets/js/19.6a5a3a4f.js"><link rel="prefetch" href="/assets/js/20.4e3a2c2d.js"><link rel="prefetch" href="/assets/js/21.8d27132f.js"><link rel="prefetch" href="/assets/js/22.9c8a6a11.js"><link rel="prefetch" href="/assets/js/24.7ab666ac.js"><link rel="prefetch" href="/assets/js/25.18fee9f2.js"><link rel="prefetch" href="/assets/js/26.20dee706.js"><link rel="prefetch" href="/assets/js/27.ee15d5bf.js"><link rel="prefetch" href="/assets/js/28.bc8df6f0.js"><link rel="prefetch" href="/assets/js/29.ff1a72ec.js"><link rel="prefetch" href="/assets/js/3.3cdc0523.js"><link rel="prefetch" href="/assets/js/30.ea9eec55.js"><link rel="prefetch" href="/assets/js/31.e7923f98.js"><link rel="prefetch" href="/assets/js/32.b95c37f1.js"><link rel="prefetch" href="/assets/js/33.016ae840.js"><link rel="prefetch" href="/assets/js/34.30686f5b.js"><link rel="prefetch" href="/assets/js/35.6c89543d.js"><link rel="prefetch" href="/assets/js/36.956af833.js"><link rel="prefetch" href="/assets/js/37.4d678732.js"><link rel="prefetch" href="/assets/js/38.3f50233a.js"><link rel="prefetch" href="/assets/js/39.2511b148.js"><link rel="prefetch" href="/assets/js/4.be256ac2.js"><link rel="prefetch" href="/assets/js/5.18e64c06.js"><link rel="prefetch" href="/assets/js/6.a9b62d79.js"><link rel="prefetch" href="/assets/js/7.b14ef36b.js"><link rel="prefetch" href="/assets/js/8.a4b42cae.js"><link rel="prefetch" href="/assets/js/9.37ec6401.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6d920bc0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">honkerzhou</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/tutorial/" class="nav-link">
  教程
</a></div><div class="nav-item"><a href="/javascript/" class="nav-link router-link-active">
  JS
</a></div><div class="nav-item"><a href="/app/" class="nav-link">
  APP
</a></div><div class="nav-item"><a href="/data-visualization/" class="nav-link">
  数据可视化
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/essential/markdown.html" class="nav-link">
  Markdown
</a></li><li class="dropdown-item"><!----> <a href="/essential/vscode.html" class="nav-link">
  Vscode
</a></li><li class="dropdown-item"><!----> <a href="/essential/interview.html" class="nav-link">
  面试
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/tutorial/" class="nav-link">
  教程
</a></div><div class="nav-item"><a href="/javascript/" class="nav-link router-link-active">
  JS
</a></div><div class="nav-item"><a href="/app/" class="nav-link">
  APP
</a></div><div class="nav-item"><a href="/data-visualization/" class="nav-link">
  数据可视化
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/essential/markdown.html" class="nav-link">
  Markdown
</a></li><li class="dropdown-item"><!----> <a href="/essential/vscode.html" class="nav-link">
  Vscode
</a></li><li class="dropdown-item"><!----> <a href="/essential/interview.html" class="nav-link">
  面试
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/javascript/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/javascript/object.html" class="sidebar-link">对象（object)</a></li><li><a href="/javascript/prototype.html" class="sidebar-link">原型(prototype)</a></li><li><a href="/javascript/this.html" class="sidebar-link">/javascript/this.html</a></li><li><a href="/javascript/event-loop.html" class="sidebar-link">事件循环</a></li><li><a href="/javascript/asynchronous.html" aria-current="page" class="active sidebar-link">异步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/asynchronous.html#事件模型" class="sidebar-link">事件模型</a></li><li class="sidebar-sub-header"><a href="/javascript/asynchronous.html#回调函数" class="sidebar-link">回调函数</a></li><li class="sidebar-sub-header"><a href="/javascript/asynchronous.html#promise" class="sidebar-link">Promise</a></li><li class="sidebar-sub-header"><a href="/javascript/asynchronous.html#生成器与迭代器" class="sidebar-link">生成器与迭代器</a></li><li class="sidebar-sub-header"><a href="/javascript/asynchronous.html#async" class="sidebar-link">Async</a></li><li class="sidebar-sub-header"><a href="/javascript/asynchronous.html#多线程" class="sidebar-link">多线程</a></li><li class="sidebar-sub-header"><a href="/javascript/asynchronous.html#总结-3" class="sidebar-link">总结</a></li></ul></li><li><a href="/javascript/error-handle.html" class="sidebar-link">JS错误处理与调试</a></li><li><a href="/javascript/date-format.html" class="sidebar-link">YYYY-MM-DD与YYYY/MM/DD之错误时间戳</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="异步"><a href="#异步" class="header-anchor">#</a> 异步</h1> <p>阅读本文前，如果你对事件循环、宏任务、微任务还不清楚，先阅读上一篇<a href="/javascript/event-loop.html">事件循环</a></p> <h2 id="事件模型"><a href="#事件模型" class="header-anchor">#</a> 事件模型</h2> <p>DOM的点击事件</p> <h2 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment">// 1</span>
<span class="token comment">// 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>回调函数实现异步原理： 事件循环</p> <p>优点：解决了同步的问题</p> <p>用回调函数实现异步的缺点：</p> <ol><li>缺乏顺序性：大脑对于事情的计划方式是线性的、阻塞的、单线程的语义，但是回调表达异步流 程的方式是非线性的、非顺序的，这使得正确推导这样的代码难度很大。难于理解的代码 是坏代码，会导致坏 bug。</li> <li>缺乏可信任性：回调会受到控制反转的影响，因为回调暗中把控制权交给第三 方(通常是不受你控制的第三方工具!)来调用你代码中的 continuation。这种控制转移导 致一系列麻烦的信任问题，比如回调被调用的次数是否会超出预期。</li> <li>回调地狱：多级回调函数嵌套，使代码难以理解和维护</li></ol> <h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>本节中 Promise 代表 Promise 构造函数， promise 代表 Promise 实例</p></div> <p>Promise的出现主要解决了回调函数缺乏可信任性和回调函数过多嵌套的问题，意为“承诺”。Promise将回调嵌套改为链式调用，增加可读性和可维护性。</p> <p>promise有三种状态：</p> <ul><li>初始状态（pending）</li> <li>已完成（fullfilled）</li> <li>已拒绝（rejected）</li></ul> <p>一旦决议(resolve)，promise就处于完成或拒绝状态，并且不会再被修改。如果没有使用任何值显式决议promise， 那么这个实例的决议值就是 undefined。任何Promise 实例都只有一个决议值</p> <h3 id="thenable"><a href="#thenable" class="header-anchor">#</a> thenable</h3> <p>then()方法：接受两个参数：完成回调和拒绝回调</p> <p>thenable: 任何具有then()方法的对象，即是thenable的</p> <h3 id="new-promise"><a href="#new-promise" class="header-anchor">#</a> new Promise()</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Promise(..) 必须和 new 一起使用，并且必须提供一个回调函数——执行器。<br>
执行器接受两个回调函数作为参数，通常分别命名为resolve 和 reject。执行器函数是同步的，会被立即调用。</p> <p>如果在执行器中：</p> <ol><li>使用多个参数调用 resovle(..) 或者 reject(..)，第一个参数之后的所有参数都会被默默忽略</li> <li>多次调用resovle(..) 和 reject(..)，只有第一个生效，后续的都会被忽略</li></ol> <p>如果在执行器中,向 resolve(..):</p> <ul><li>传递一个非 promise、非 thenable 的立即值，promise的决议值就是这个立即值</li> <li>传递一个真正的 promise 或 thenable 值，promise 或 thenable 值会被递归展开，直到提取出一个具体的非 promise 和 非 thenable 的最终值，promise的决议值就是这个最终值</li></ul> <p>如果在执行器中,向 reject(..):</p> <ul><li>传递一个非 promise、非 thenable 的立即值，Promise 实例p的决议值就是这个立即值</li> <li>传递一个真正的 promise 或 thenable 值，promise 或 thenable 值会被原封不动的设置为拒绝理由，后续的拒绝处理函数接收到的就是传给reject() 的那个 promise 或 thenable 值</li></ul> <p>如果在执行器内部抛出一个错误，则promise的拒绝处理程序就会被调用</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>通过 p instanceof Promise 来检查p是不是Promise实例时，注意：</p> <ol><li>promise 值可能是从其他浏览器窗口(iframe 等)接收到的</li> <li>库或框架可能会选择实现自己的 Promise，而不是使用原生 ES6 Promise 实现</li></ol></div> <h3 id="promise-resolve-和promise-reject"><a href="#promise-resolve-和promise-reject" class="header-anchor">#</a> Promise.resolve()和Promise.reject()</h3> <p>这两个方法的调用不会有任务编排的过程</p> <p>Promise.resolve()和Promise.reject() 分别是创建一个已经决议和已被拒绝的 Promise实例的快捷方式</p> <p>如果向 Promise.resolve(..)：</p> <ul><li>传递一个非 promise、非 thenable 的立即值，就会返回一个用这个值填充的 Promise实例</li> <li>传递了一个非 promise 的 thenable 值，会将这个对象转为 Promise 对象，然后就立即执行thenable对象的then方法（即：试图展开这个 thenable 值，持续到提取出一个具体的非类 promise 的最终值）</li> <li>传递一个真正的 promise，就会返回同一个 promise （注意此处与执行器函数中调用resolve(..)不同）</li></ul> <p>Promise.reject(..) 不会像 Promise.resolve(..) 一样进行展开。如果向 Promise.reject(..) 传入一个 Promise/thenable 值，它会把这个值原封不动地设置为返回的promise的 拒绝理由。后续的拒绝处理函数接收到的是你实际传给 Promise.reject(..) 的那个 Promise/thenable，而不是其底层的立即值。</p> <h3 id="promise-then-和promise-catch"><a href="#promise-then-和promise-catch" class="header-anchor">#</a> promise.then()和promise.catch()</h3> <ol><li>每次你对 promise 调用 then(..)和 catch(..)，它都会创建并返回一个新的 promise</li> <li>每次调用then()方法或catch()方法都会创建一个新任务，当promise被解决时会被加入到当前事件循环回合的微任务队列（microtask queue）</li></ol> <p>Promise.then()，接受两个参数，第一个用于完成回调，第二个用于拒绝回调：</p> <ol><li>不管从 then(..)的完成回调返回的值是什么（或者返回一个异常），它都会被自动设置 为被链接的 promise的完成值</li> <li>不管从 then(..) 的拒绝回调返回的值是什么，它都会被自动设置 为被链接的 promise的拒绝值</li> <li>在 then(..) 的完成拒绝回调或者拒绝回调中抛出一个错误，它都会被自动设置 为被链接的 promise的拒绝值</li></ol> <p>如果从完成或拒绝处理函数：</p> <ul><li>返回一个立即值，这个值就会被用作返回promise的完成值或拒绝值</li> <li>返回 thenable 或者 Promise 的时候会发生同样的展开，而且展开过程会持续到提取出一个具体的非thenable或非 Promise 的最终值</li></ul> <p>如果你调用 promise 的 then(..)，并且只传入一个完成处理函数，一个默认拒绝处理函数 就会顶替上来。默认拒绝处理函数只是把错误重新抛出</p> <p>如果没有给 then(..) 传递一个适当有效的函数作为完成处理函数参数，还是会有作为替代 的一个默认处理函数。默认的完成处理函数只是把接收到的任何传入值传递给下一个步骤</p> <p>promise.catch(..)等同于promise.then(null, function(){})</p> <h3 id="promise-all-和promise-race"><a href="#promise-all-和promise-race" class="header-anchor">#</a> Promise.all()和Promise.race()</h3> <p>Promise.all():</p> <ol><li>传给 Promise.all([ .. ]) 的数组中的值可以是 Promise、 thenable，甚至是立即值。就本质而言，列表中的每个值都会通过 Promise.resolve(..) 过滤，以确保要等待的是一个真正的 Promise，所以立即值会 被规范化为这个值构建的 Promise。如果数组是空的，主 Promise 就会立 即完成。</li> <li>从Promise.all([ .. ])返回的主promise在且仅在所有的成员promise都完成后才会完 成。如果这些promise中有任何一个被拒绝的话，主Promise.all([ .. ])promise就会立 即被拒绝，并丢弃来自其他所有 promise 的全部结果。（即只会得到第一个拒绝promise的拒绝理由值）</li> <li>如果数组列表中的promise有自己的catch()方法，则一旦它被rejected，并不会触发Promise.all()的catch方法</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  Promise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> resArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>i<span class="token punctuation">,</span> p<span class="token punctuation">]</span> <span class="token keyword">of</span> arr<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token operator">++</span>count
          resArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> res
          <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>resArr<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Promise.race():</p> <ol><li>Promise.race([ .. ])接受单个数组参数，数组中的值可以是 Promise、 thenable和立即值。显然数组中的第一个立即值永远都是第一个完成的</li> <li>Promise.race([ .. ])中，一旦有任何一个Promise决议为完成/拒绝，Promise.race([ .. ])就会完成/拒绝</li> <li>如果你传入了一个空数组，Promise. race([..]) 永远不会决议</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  Promise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">iterable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> p <span class="token keyword">of</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="promise-prototype-finally"><a href="#promise-prototype-finally" class="header-anchor">#</a> Promise.prototype.finally()</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">finally</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token constant">P</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>constructor
  <span class="token keyword">const</span> <span class="token function-variable function">onFulFilled</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// P.resolve(cb())是为了兼容cb是异步函数的情况</span>
    <span class="token keyword">return</span> <span class="token constant">P</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> data
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">P</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> err
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulFilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="promise拒绝事件"><a href="#promise拒绝事件" class="header-anchor">#</a> Promise拒绝事件</h3> <p>Node.js中：</p> <ul><li>unhandledRejection 在一个事件循环中，当Promise被拒绝，并且没有提供拒绝处理程序时触发。事件处理程序的参数为一个错误对象和被拒绝的promise</li> <li>rejectHandled 在一个事件循环后，当Promise被拒绝，若拒绝处理程序被调用时触发。事件处理程序的参数只有一个：被拒绝的promise</li></ul> <p>浏览器中：</p> <ul><li>unhandledrejection 触发条件同Node.js的unhandledRejection</li> <li>rejecthandled 触发条件同Node的rejectHandled</li></ul> <p>浏览器中这两个事件的事件处理程序都只接受一个事件对象为参数</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>优点：
Promise主要解决了回调函数缺乏可信任性和回调函数过多嵌套的问题，意为“承诺”。Promise将回调嵌套改为链式调用，增加可读性和可维护性。
Promise 缺点：</p> <ol><li>无法取消</li> <li>如果不设置回调函数，Promise内部抛出的错误，不会反应到外部</li> <li>当处于pending状态时，无法得知目前进展到哪一个阶段（刚刚开始还是即将完成）</li></ol> <h2 id="生成器与迭代器"><a href="#生成器与迭代器" class="header-anchor">#</a> 生成器与迭代器</h2> <h3 id="生成器"><a href="#生成器" class="header-anchor">#</a> 生成器</h3> <p>生成器(generator)的出现主要解决了回调函数缺乏顺序性的问题，用顺序、看似同步的表达风格控制异步流程(具有依赖关系的Promise依然会嵌套调用Promise，并且链式的Promise难以处理某些条件下需要断开链式调用的场景)。</p> <p>Generator实现的核心在于上下文的保存，函数并没有真的被挂起，每一次yield，其实都执行了一遍传入的生成器函数，只是在这个过程中间用了一个context对象储存上下文，使得每次执行生成器函数的时候，都可以从上一个执行结果开始执行，看起来就像函数被挂起了一样</p> <p><strong>生成器</strong>是一种返回迭代器的函数<br>
yield只可以用在生成器内部，并且和return一样，不能穿透函数边界，即yield只能用在生成器函数的直接作用域中
yield表达式如果用在另一个表达式之中，必须放在圆括号里面<br>
yield表达式用作函数参数或放在赋值表达式的右边，可以不加括号
不能用箭头函数来创建生成器<br>
声明格式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 第一种</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 第二种</span>
<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 第三种</span>
<span class="token keyword">function</span><span class="token operator">*</span><span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="迭代器"><a href="#迭代器" class="header-anchor">#</a> 迭代器</h3> <p>迭代器(iterator)的出现旨在消除多个循环嵌套产生的复杂性并减少循环中的错误</p> <p><strong>迭代器</strong>是一种特殊对象，具有一个next()方法，每次调用这个方法都返回一个对象，这个对象中有两个属性：</p> <ol><li>value：表示下一个将要返回的值</li> <li>done：布尔类型，当没有更多可返回数据时返回true</li></ol> <p>迭代器中还保存有一个内部指针，用来指向当前集合中值的位置，每调用一次next()，都返回下一个可用的值</p> <p><strong>iterable(可迭代)对象</strong>：指包含一个可以在其值上迭代的迭代器的对象<br>
iterable 对象内部必须支持一个函数属性，其名称 是专门的 ES6 符号值 Symbol.iterator。调用这个函数时，它会返回一个迭代器。</p> <p>生成器函数默认会为通过生成器创建的迭代器对象添加Symbol.iterator属性，故此类迭代器都是可迭代对象</p> <p>默认情况下，开发者定义的对象都不是可迭代对象</p> <p>for-of循环与迭代器息息相关，每执行一次都会调用可迭代对象的next()方法，并将返回的结果对象的value属性存储在一个变量中，循环持续执行到返回对象的done属性为true</p> <p>数组、Map、Set都内建了三种迭代器:entries()、values()、keys()</p> <p>数组的keys()迭代器，使用for-of只会针对数字类型的索引。但对数组用for-in，则会包含数组属性（可以开发者自己添加）</p> <p>数组和Set的默认迭代器是values(),Map的是entries()<br>
默认的数组迭代器并不关心通过 next(..) 调用发送的任何消息</p> <p>展开运算符可以用于任何可迭代对象</p> <h3 id="迭代器与生成器的合作"><a href="#迭代器与生成器的合作" class="header-anchor">#</a> 迭代器与生成器的合作</h3> <p>调用生成器函数生成一个迭代器，实际上就隐式构建了生成器的一个实例，通过这个迭代器来控制的是这个生成器实例。</p> <p>规范和所有兼容浏览器都会默默丢弃传递给第一个 next() 的任何东西。因此，启动生成器时一定要用不带参数的 next()。</p> <p>迭代器调用throw()方法抛出的错误如果在生成器内部被捕获了，会继续执行下一条yield语句，返回结果对象</p> <p>在生成器中使用return，结果对象的done属性会被设为true，如果return了值，则结果对象的value属性为该值</p> <p>可以在外部通过return(..) 手工终止生成器的迭代器实例：it.return( &quot;Hello World&quot; )</p> <h3 id="委托生成器"><a href="#委托生成器" class="header-anchor">#</a> 委托生成器</h3> <p>在生成器函数内部，将星号放在yield和生成器函数名之间，则产生了委托生成器<br>
委托生成器内部的return回的值不会反映在外部的生成器，但是可以将委托生成器函数的返回值赋给一个变量（如result），再添加一条yield语句（如yield result），则外部的生成器的迭代器的返回对象中的value值为该值，done值不受该return影响</p> <h3 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h3> <p>生成器优点：可以控制函数的执行</p> <h2 id="async"><a href="#async" class="header-anchor">#</a> Async</h2> <p>async 函数会返回一个 promise，可以使用then方法添加回调函数。当函数执行的时候一旦遇到 await 就会先返回，等到触发的异步操作完成，再执行该 async 函数体内后面的语句（统一放在微任务里处理）。在 async 函数完全结束之后，其返回的 promise 会决议。</p> <p>async函数内部return语句返回的值，会成为then方法回调函数的参数</p> <p>async函数内部抛出错误，会导致返回的 Promise 对象变为reject状态。抛出的错误对象会被catch方法回调函数接收到</p> <p>正常情况下，await命令后面是一个 Promise 对象，返回该对象的结果。如果不是 Promise 对象，就直接返回对应的值</p> <p>另一种情况是，await命令后面是一个thenable对象（即定义了then方法的对象），那么await会将其等同于 Promise 对象（即等待then方法执行完）</p> <p>在 Promise 中 resolve 一个 thenable 对象”，需要先将 thenable 转化为 Promsie，然后立即调用 thenable 的 then 方法，并且 这个过程需要作为一个 job 加入微任务队列，以保证对 then 方法的解析发生在其他上下文代码的解析之后</p> <p>对于 await v：
await 后的值 v 会被转换为 Promise
即使 v 是一个已经 fulfilled 的 Promise，还是会新建一个 Promise，并在这个新 Promise 中 resolve(v)
await v 后续的代码的执行类似于传入 then() 中的回调</p> <p>任何一个await语句后面的 Promise 对象变为reject状态，那么整个async函数都会中断执行，等同于async函数返回的 Promise 对象被reject</p> <h2 id="多线程"><a href="#多线程" class="header-anchor">#</a> 多线程</h2> <h2 id="总结-3"><a href="#总结-3" class="header-anchor">#</a> 总结</h2> <p>获得 Promise 和生成器最大效用的最自然的方法就是 yield 出来一个 Promise，然后通过这个 Promise 来控制生成器的迭代器。</p> <p>在异步控制流程方面，生成器的关键优点是:生成器内部的代码是以自然的同步 / 顺序方 式表达任务的一系列步骤。其技巧在于，我们把可能的异步隐藏在了关键字 yield 的后面， 把异步移动到控制生成器的迭代器的代码部分。
换句话说，生成器为异步代码保持了顺序、同步、阻塞的代码模式，这使得大脑可以更自 然地追踪代码，解决了基于回调的异步的两个关键缺陷之一。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/9/2022, 6:38:52 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/javascript/event-loop.html" class="prev">
        事件循环
      </a></span> <span class="next"><a href="/javascript/error-handle.html">
        JS错误处理与调试
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6ddf0b71.js" defer></script><script src="/assets/js/2.4f1b6d11.js" defer></script><script src="/assets/js/23.8beb0211.js" defer></script>
  </body>
</html>
